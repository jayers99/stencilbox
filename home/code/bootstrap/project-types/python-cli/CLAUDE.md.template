# CLAUDE.md

This file provides guidance to Claude Code when working with this codebase.

## Project Overview

**Name:** {{PROJECT_NAME}}
**Description:** {{PROJECT_DESCRIPTION}}
**Type:** Python CLI
**Reference Implementation:** `~/code/shuffle-aws-vaults/`

## Development Commands

```bash
# Install dependencies and package
pipenv install --dev
pipenv install -e .

# Testing
pipenv run pytest                    # Run all tests
pipenv run pytest -v                 # Verbose output
pipenv run pytest --cov              # With coverage report
pipenv run pytest tests/unit/        # Unit tests only

# Code quality
pipenv run black .                   # Format code
pipenv run black --check .           # Check formatting
pipenv run ruff check .              # Lint
pipenv run ruff check --fix .        # Auto-fix lint issues
pipenv run mypy src/                 # Type check

# Running the CLI
pipenv run {{CLI_NAME}} --help
pipenv run {{CLI_NAME}} --version
pipenv run {{CLI_NAME}} <command> --dry-run

# Or activate the virtualenv first
pipenv shell
{{CLI_NAME}} --help
exit  # to deactivate
```

## Environment Setup

**pipenv venv location:** Set `PIPENV_VENV_IN_PROJECT=1` in your shell profile to keep `.venv/` in the project root.

**Global CLI access (run from any directory):**

```bash
# Add to ~/.zshrc
alias {{CLI_NAME}}='PIPENV_PIPFILE=~/code/{{PROJECT_NAME}}/Pipfile pipenv run {{CLI_NAME}}'
```

## Architecture

This project follows Domain-Driven Design (DDD) with three layers:

```
src/{{PROJECT_NAME}}/
├── cli.py              # Entry point (argparse, subcommands)
├── domain/             # Pure business logic, no external dependencies
├── application/        # Use cases and orchestration (Protocol-based)
└── infrastructure/     # Cloud SDKs, I/O, config, logging, retry
```

**Layer Rules:**

- **domain/** - Pure Python dataclasses, no imports from other layers, fully testable without mocks
- **application/** - Orchestrates domain objects, depends on Protocol interfaces (not concrete implementations)
- **infrastructure/** - External integrations, implements Protocol interfaces

**Protocol Pattern Example:**

```python
# application/list_service.py
from typing import Protocol

class BackupRepository(Protocol):
    def list_vaults(self, region: str) -> list[Vault]: ...

class ListService:
    def __init__(self, repository: BackupRepository) -> None:
        self._repository = repository

    def execute(self, region: str) -> list[Vault]:
        return self._repository.list_vaults(region)
```

**Infrastructure Patterns:**

For retry, logging, signal handling patterns, see reference implementation:
`~/code/shuffle-aws-vaults/src/shuffle_aws_vaults/infrastructure/`

## Code Conventions

### File Metadata

Every `.py` file must include:

```python
#!/usr/bin/env python3
"""Module description here."""

__version__ = "0.1.0"
__author__ = "John Ayers"

def file_info() -> dict[str, str]:
    return {
        "name": "module_name",
        "description": "...",
        "version": __version__,
        "author": __author__,
        "last_updated": "YYYY-MM-DD",
    }
```

### CLI Exit Codes

| Code | Meaning |
|------|---------|
| 0 | Success |
| 1 | Error (validation, API failure, etc.) |
| 2 | Incomplete (timeout, partial completion) |

### Type Hints

Use modern Python 3.12+ syntax:
- `list[T]` not `List[T]`
- `dict[K, V]` not `Dict[K, V]`
- `X | Y` not `Union[X, Y]`
- `X | None` not `Optional[X]`

## AI Team Agreement

### Development Practices

- **TDD Always**: Red-Green-Refactor cycle. Never write implementation without a failing test first.
- **One Story at a Time**: WIP limit of 1. Complete current work before starting new.
- **Small Commits**: Commit after each meaningful change. Each commit should leave codebase working.

### Branch & PR Workflow

- **Branch Naming**: `feature/STORY-N-description` or `bugfix/BUG-N-description`
- **PR Flow**:
  1. Claude creates branch and PR
  2. GitHub Copilot auto-reviews
  3. Claude polls for review completion (every 30 seconds)
  4. Claude addresses Copilot comments
  5. Human runs UAT and approves
  6. Squash merge, delete branch
  7. Claude creates semver release

### Commit Messages

Format: `<type>: <short description>`

| Type | Use For |
|------|---------|
| `feat` | New feature |
| `fix` | Bug fix |
| `test` | Adding/updating tests |
| `refactor` | Code change without feature/fix |
| `docs` | Documentation only |
| `chore` | Maintenance, dependencies |

### Communication Signals

**Human to AI:**
- **"Stop"** - Halt immediately, wait for instructions
- **"Pause"** - Checkpoint progress, summarize state, wait
- **"Clarify"** - Need to understand before proceeding

**AI to Human:**
- Signal when confused or blocked
- Ask before making assumptions
- Propose plans before executing
- Never proceed when uncertain about destructive actions

### Definition of Done

- [ ] Code compiles/runs without errors
- [ ] All tests pass (unit + integration)
- [ ] No linter errors or warnings
- [ ] Code reviewed (Copilot + Human)
- [ ] Documentation updated (if user-facing changes)
- [ ] Commit message follows convention
- [ ] PR includes UAT instructions

### Releases

After every merged PR:
- `fix:` commits = PATCH bump (1.0.0 -> 1.0.1)
- `feat:` commits = MINOR bump (1.0.0 -> 1.1.0)
- Breaking changes = MAJOR bump (1.0.0 -> 2.0.0)

## Key Files

| File | Purpose |
|------|---------|
| `BACKLOG.md` | Current stories and tasks |
| `CHANGELOG.md` | Release history |
| `docs/requirements.md` | What we're building |

## Session Startup

When starting a new session:

```
Read CLAUDE.md, then BACKLOG.md, then recent git log.
Summarize where we are and ask what to work on.
```
